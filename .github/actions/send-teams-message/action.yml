name: 'Send Teams Message'
description: 'Sends a simple Microsoft Teams notification'

inputs:
  webhook_url:
    description: 'Microsoft Teams webhook URL'
    required: true
  title:
    description: 'Title of the notification'
    required: true
  message:
    description: 'Main message to display'
    required: true
  color:
    description: 'Color accent for the card (Accent, Good, Warning, Attention)'
    required: false
    default: 'Accent'
  show_files:
    description: 'Whether to show changed files list'
    required: false
    default: 'false'
  changed_files:
    description: 'List of changed files'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Send Teams notification
      shell: bash
      run: |
        set -e
        
        WEBHOOK_URL="${{ inputs.webhook_url }}"
        TITLE="${{ inputs.title }}"
        MESSAGE="${{ inputs.message }}"
        COLOR="${{ inputs.color }}"
        SHOW_FILES="${{ inputs.show_files }}"
        FILES="${{ inputs.changed_files }}"
        
        # Validate webhook
        if [ -z "$WEBHOOK_URL" ]; then
          echo "âŒ Missing webhook_url"
          exit 1
        fi
        
        # Show webhook (masked for security - only first/last 10 chars)
        WEBHOOK_PREFIX="${WEBHOOK_URL:0:50}"
        WEBHOOK_SUFFIX="${WEBHOOK_URL: -10}"
        echo "ðŸ”— Using webhook: ${WEBHOOK_PREFIX}...${WEBHOOK_SUFFIX}"
        
        # Map color to Teams theme color
        case "$COLOR" in
          Good) THEME_COLOR="00FF00" ;;
          Warning) THEME_COLOR="FFA500" ;;
          Attention) THEME_COLOR="FF0000" ;;
          *) THEME_COLOR="0078D4" ;;
        esac
        
        # Build files section
        FILES_TEXT=""
        if [ "$SHOW_FILES" = "true" ] && [ -n "$FILES" ]; then
          FILES_TEXT=" | Files Changed: ${FILES}"
        fi
        
        # Simple JSON payload (MessageCard format)
        cat > /tmp/payload.json <<EOF
        {
          "@type": "MessageCard",
          "@context": "https://schema.org/extensions",
          "themeColor": "${THEME_COLOR}",
          "title": "${TITLE}",
          "text": "${MESSAGE}${FILES_TEXT}",
          "sections": [
            {
              "facts": [
                {
                  "name": "Repository",
                  "value": "${{ github.repository }}"
                },
                {
                  "name": "Branch",
                  "value": "${{ github.ref_name }}"
                },
                {
                  "name": "Commit",
                  "value": "${{ github.sha }}"
                },
                {
                  "name": "Triggered by",
                  "value": "${{ github.actor }}"
                }
              ]
            }
          ],
          "potentialAction": [
            {
              "@type": "OpenUri",
              "name": "View Commit",
              "targets": [
                {
                  "os": "default",
                  "uri": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
                }
              ]
            }
          ]
        }
        EOF
        
        echo "ðŸ“‹ Payload being sent:"
        cat /tmp/payload.json
        echo ""
        
        # Send to Teams
        echo "ðŸ“¤ Sending notification to Microsoft Teams..."
        
        HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -d @/tmp/payload.json \
          "$WEBHOOK_URL")
        
        echo "ðŸ“Š HTTP Response Code: $HTTP_CODE"
        echo "ðŸ“„ Response Body:"
        cat /tmp/response.txt
        echo ""
        
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
          echo "âœ… Teams notification sent successfully!"
          echo "ðŸ’¡ If you don't see it in Teams:"
          echo "   1. Check you're in the correct Teams channel"
          echo "   2. Verify the webhook is still active in Teams Connectors"
          echo "   3. Try creating a new webhook and updating the secret"
        else
          echo "âŒ Teams webhook failed (HTTP $HTTP_CODE)"
          exit 1
        fi
