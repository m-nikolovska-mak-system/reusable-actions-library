name: Assign Jira Issue

on:
  workflow_call:
    inputs:
      issue_key:
        description: 'Jira issue key (e.g. ABC-123)'
        required: true
        type: string
      assignee_email:
        description: 'Assignee email in Jira'
        required: true
        type: string
    secrets:
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true
      JIRA_URL:
        required: true

jobs:
  assign:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq and python3
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq python3

      - name: Assign issue in Jira
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_URL: ${{ secrets.JIRA_URL }}
          ISSUE_KEY: ${{ inputs.issue_key }}
          ASSIGNEE_EMAIL: ${{ inputs.assignee_email }}
        run: |  
          set -euo pipefail

          echo "üîç Validating required secrets..."
          if [[ -z "${JIRA_EMAIL}" || -z "${JIRA_API_TOKEN}" || -z "${JIRA_URL}" ]]; then
            echo "::error::Missing required Jira secrets"
            exit 1
          fi

          echo "üîé Searching Jira user: ${ASSIGNEE_EMAIL}"
          QUERY_ENC=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))" "${ASSIGNEE_EMAIL}")

          # More reliable curl (retry, fail on non-2xx)
          SEARCH_JSON=$(curl --silent --fail --location \
            --retry 3 --retry-delay 2 \
            -u "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            "${JIRA_URL}/rest/api/3/user/search?query=${QUERY_ENC}"
          )

          ACCOUNT_ID=$(echo "${SEARCH_JSON}" | jq -r '.[0].accountId // empty')

          if [[ -z "${ACCOUNT_ID}" ]]; then
            echo "::error::Jira user not found for email: ${ASSIGNEE_EMAIL}"
            echo "Response: ${SEARCH_JSON}"
            exit 1
          fi

          echo "‚úÖ Found Jira accountId: ${ACCOUNT_ID}"

          PAYLOAD=$(jq -n --arg acc "${ACCOUNT_ID}" '{accountId: $acc}')

          echo "üìå Assigning issue ${ISSUE_KEY} ‚Üí ${ASSIGNEE_EMAIL}"

          RESPONSE=$(curl --silent --output /dev/null --write-out "%{http_code}" \
            --fail --location \
            -u "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            -X PUT \
            -H "Content-Type: application/json" \
            --data "${PAYLOAD}" \
            "${JIRA_URL}/rest/api/3/issue/${ISSUE_KEY}/assignee" || true)

          if [[ "${RESPONSE}" != "204" ]]; then
            echo "::error::Assignment failed (HTTP ${RESPONSE})"
            exit 1
          fi

          echo "üéâ Successfully assigned ${ISSUE_KEY} to ${ASSIGNEE_EMAIL}"
