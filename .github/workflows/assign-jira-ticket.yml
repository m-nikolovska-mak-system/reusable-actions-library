name: Assign Jira Issue (Safe Version)

on:
  workflow_call:
    inputs:
      issue_key:
        description: "Jira issue key (e.g. ABC-123)"
        required: true
        type: string
      assignee_email:
        description: "Jira user email"
        required: true
        type: string
    secrets:
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true
      JIRA_URL:
        required: true

jobs:
  assign:
    runs-on: ubuntu-latest
    name: Safe Jira Assignment

    steps:
      - name: Ensure jq is installed
        run: |
          if ! command -v jq &>/dev/null; then
            echo "üì¶ jq not found ‚Äî installing"
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Validate inputs and secrets
        run: |
          set -euo pipefail
          echo "üîç Validating inputs..."

          # Secrets
          [[ -z "${{ secrets.JIRA_EMAIL }}" ]] && echo "::error::Missing JIRA_EMAIL" && exit 1
          [[ -z "${{ secrets.JIRA_API_TOKEN }}" ]] && echo "::error::Missing JIRA_API_TOKEN" && exit 1
          [[ -z "${{ secrets.JIRA_URL }}" ]] && echo "::error::Missing JIRA_URL" && exit 1
          
          # Inputs
          ISSUE="${{ inputs.issue_key }}"
          EMAIL="${{ inputs.assignee_email }}"

          [[ -z "$ISSUE" ]] && echo "::error::Missing issue key" && exit 1
          [[ -z "$EMAIL" ]] && echo "::error::Missing assignee email" && exit 1

          if ! [[ "$ISSUE" =~ ^[A-Z][A-Z0-9]+-[0-9]+$ ]]; then
            echo "::error::Issue key format invalid. Expected: ABC-123"
            exit 1
          fi

          if ! [[ "$EMAIL" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            echo "::error::Invalid email format"
            exit 1
          fi

          echo "‚úÖ Validation passed"

      - name: Search Jira user by email
        id: search_user
        run: |
          set -euo pipefail
          echo "üîé Looking up user: ${{ inputs.assignee_email }}"

          ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${{ inputs.assignee_email }}'))")
          echo "encoded=$ENCODED" >> $GITHUB_OUTPUT

          curl -sS \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_URL }}/rest/api/3/user/search?query=$ENCODED" \
            -o users.json

          COUNT=$(jq 'length' users.json)

          if [[ "$COUNT" -eq 0 ]]; then
            echo "::error::No Jira user found for this email"
            cat users.json
            exit 1
          fi

          if [[ "$COUNT" -gt 1 ]]; then
            echo "::error::Multiple Jira users match this email ‚Äî ambiguous"
            cat users.json
            exit 1
          fi

          ACCOUNT_ID=$(jq -r '.[0].accountId' users.json)
          DISPLAY_NAME=$(jq -r '.[0].displayName' users.json)

          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "display_name=$DISPLAY_NAME" >> $GITHUB_OUTPUT

          echo "‚úÖ Found user: $DISPLAY_NAME ($ACCOUNT_ID)"

      - name: Check if user is assignable for this issue
        id: check_assignable
        run: |
          set -euo pipefail
          ISSUE="${{ inputs.issue_key }}"
          ACC="${{ steps.search_user.outputs.account_id }}"

          echo "üîç Checking if user is assignable for $ISSUE..."

          curl -sS \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_URL }}/rest/api/3/user/assignable/search?issueKey=$ISSUE" \
            -o assignable.json

          # Check whether accountId appears
          MATCH=$(jq --arg acc "$ACC" '.[] | select(.accountId == $acc)' assignable.json || true)

          if [[ -z "$MATCH" ]]; then
            echo "::error::User exists but cannot be assigned issues in this project or workflow state"
            echo ""
            echo "Possible reasons:"
            echo " - User is not in project roles"
            echo " - User lacks 'Assign Issues' permission"
            echo " - Workflow state prevents assignment"
            exit 1
          fi

          echo "‚úÖ User is assignable"

      - name: Assign Jira issue
        run: |
          set -euo pipefail
          ISSUE="${{ inputs.issue_key }}"
          ACC="${{ steps.search_user.outputs.account_id }}"
          NAME="${{ steps.search_user.outputs.display_name }}"

          PAYLOAD=$(jq -n --arg acc "$ACC" '{accountId: $acc}')

          echo "üìå Assigning $ISSUE ‚Üí $NAME"

          # Try PUT first
          HTTP=$(curl -sS -w "%{http_code}" -o resp.json \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -X PUT \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD" \
            "${{ secrets.JIRA_URL }}/rest/api/3/issue/$ISSUE/assignee"
          )

          if [[ "$HTTP" == "204" ]]; then
            echo "üéâ Successfully assigned using PUT"
            exit 0
          fi

          if [[ "$HTTP" == "405" ]]; then
            echo "‚ö†Ô∏è PUT not allowed ‚Äî retrying with POST..."
            HTTP2=$(curl -sS -w "%{http_code}" -o resp.json \
              -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "$PAYLOAD" \
              "${{ secrets.JIRA_URL }}/rest/api/3/issue/$ISSUE/assignee"
            )

            if [[ "$HTTP2" == "204" ]]; then
              echo "üéâ Successfully assigned using POST"
              exit 0
            fi
          fi

          echo "::error::Failed to assign issue (HTTP $HTTP)"
          cat resp.json
          exit 1
