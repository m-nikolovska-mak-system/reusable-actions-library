name: Assign Jira Issue

on:
  workflow_call:
    inputs:
      issue_key:
        description: 'Jira issue key (e.g. ABC-123)'
        required: true
        type: string
      assignee_email:
        description: 'Assignee email in Jira'
        required: true
        type: string
    secrets:
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true
      JIRA_URL:
        required: true

jobs:
  assign:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq and python3
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq python3

      - name: Assign issue in Jira
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_URL: ${{ secrets.JIRA_URL }}
          ISSUE_KEY: ${{ inputs.issue_key }}
          ASSIGNEE_EMAIL: ${{ inputs.assignee_email }}
        run: |
          set -e
          if [ -z "$JIRA_EMAIL" ] || [ -z "$JIRA_API_TOKEN" ] || [ -z "$JIRA_URL" ]; then
            echo "Missing Jira secrets"
            exit 1
          fi

          echo "Looking up Jira user by email: $ASSIGNEE_EMAIL"
          QUERY_ENC=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))" "$ASSIGNEE_EMAIL")
          SEARCH_JSON=$(curl -s -u "$JIRA_EMAIL:$JIRA_API_TOKEN" "$JIRA_URL/rest/api/3/user/search?query=$QUERY_ENC")
          ACCOUNT_ID=$(echo "$SEARCH_JSON" | jq -r '.[0].accountId // empty') || true

          if [ -z "$ACCOUNT_ID" ]; then
            echo "User not found: $ASSIGNEE_EMAIL"
            echo "Response: $SEARCH_JSON"
            exit 1
          fi

          echo "Found accountId: $ACCOUNT_ID"
          PAYLOAD=$(jq -n --arg acc "$ACCOUNT_ID" '{accountId: $acc}')

          echo "Assigning issue $ISSUE_KEY to $ASSIGNEE_EMAIL"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -X PUT \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD" \
            "$JIRA_URL/rest/api/3/issue/$ISSUE_KEY/assignee")

          if [ "$RESPONSE" -ne 204 ]; then
            echo "Failed. HTTP: $RESPONSE"
            exit 1
          fi

          echo "Success: Issue $ISSUE_KEY â†’ $ASSIGNEE_EMAIL"
