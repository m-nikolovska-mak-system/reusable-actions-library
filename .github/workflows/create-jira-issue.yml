# Create Jira Issue (Reusable)
on:
  workflow_call:
    inputs:
      project_key:
        required: true
        type: string
      issuetype:
        required: false
        default: "Task"
        type: string
      summary:
        required: true
        type: string
      description:
        required: false
        type: string
    secrets:
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true
      JIRA_URL:
        required: true


    outputs:
      issue_key:
        description: "Generated Jira issue key (ex: ERP-123)"
        value: ${{ jobs.create-jira.outputs.issue_key }}

jobs:
  create-jira:
    runs-on: ubuntu-latest
    outputs:
      issue_key: ${{ steps.create.outputs.issue_key }}


    
    steps:
      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq


      - name: Validate project key
        run: |
          if [[ ! "${{ inputs.project_key }}" =~ ^[A-Z]+$ ]]; then
            echo "âŒ Invalid project key '${{ inputs.project_key }}'."
            echo "ðŸ‘‰ Expected something like 'ERP', not 'ERP-28'."
            exit 1
          fi
      

      - name: Create Jira issue
        id: create
        run: |
          SUMMARY="${{ inputs.summary }}"
          DESCRIPTION="${{ inputs.description }}"
          PROJECT="${{ inputs.project_key }}"
          TYPE="${{ inputs.issuetype }}"

          PAYLOAD=$(jq -n \
            --arg proj "$PROJECT" \
            --arg sum "$SUMMARY" \
            --arg desc "$DESCRIPTION" \
            --arg type "$TYPE" \
            '{
              fields: {
                project: { key: $proj },
                summary: $sum,
                issuetype: { name: $type },
                description: {
                  type: "doc",
                  version: 1,
                  content: [
                    { type: "paragraph", content: [ { type: "text", text: $desc } ] }
                  ]
                }
              }
            }'
          )

          echo "Request payload:"
          echo "$PAYLOAD"

          RESPONSE=$(curl -s -D /tmp/headers \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST \
            --data "$PAYLOAD" \
            "${{ secrets.JIRA_URL }}/rest/api/3/issue")

          echo "Jira response:"
          echo "$RESPONSE"

          ISSUE_KEY=$(echo "$RESPONSE" | jq -r '.key // empty')

          if [ -z "$ISSUE_KEY" ]; then
            echo "::error::Jira issue creation failed"
            echo "Headers:"
            cat /tmp/headers
            exit 1
          fi

          echo "issue_key=$ISSUE_KEY" >> $GITHUB_OUTPUT
