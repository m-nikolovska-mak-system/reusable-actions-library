
# Create Jira Issue (Reusable)
on:
  workflow_call:
    inputs:
      project_key:
        description: "Jira project key"
        required: true
        type: string
      issuetype:
        description: "Issue type (default: Task)"
        required: false
        default: "Task"
        type: string
      summary:
        description: "Summary for the Jira issue"
        required: true
        type: string
      description:
        description: "Description for the Jira issue"
        required: false
        type: string
    secrets:
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true
      JIRA_URL:
        required: true

jobs:
  create-jira:
    runs-on: ubuntu-latest
    outputs:
      issue_key: ${{ steps.create.outputs.issue_key }}
    steps:
      - name: Ensure jq is installed
        run: |
          if ! command -v jq >/dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Create Jira issue
        id: create
        run: |
          SUMMARY="${{ inputs.summary }}"
          DESCRIPTION="${{ inputs.description }}"
          PROJECT="${{ inputs.project_key }}"
          TYPE="${{ inputs.issuetype }}"

          PAYLOAD=$(jq -n \
            --arg proj "$PROJECT" \
            --arg sum "$SUMMARY" \
            --arg desc "$DESCRIPTION" \
            --arg type "$TYPE" \
            '{
              fields: {
                project: { key: $proj },
                summary: $sum,
                issuetype: { name: $type },
                description: {
                  type: "doc",
                  version: 1,
                  content: [
                    { type: "paragraph", content: [{ type: "text", text: $desc }] }
                  ]
                }
              }
            }'
          )

          RESPONSE=$(curl -s -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -X POST -H "Content-Type: application/json" \
            --data "$PAYLOAD" "${{ secrets.JIRA_URL }}/rest/api/3/issue")

          ISSUE_KEY=$(echo "$RESPONSE" | jq -r '.key // empty')
          echo "issue_key=$ISSUE_KEY" >> $GITHUB_OUTPUT
