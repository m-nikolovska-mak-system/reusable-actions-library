name: Reusable Teams Notifier

on:
  workflow_call:
    inputs:
      notification_title:
        description: 'Title for the Teams card'
        required: false
        type: string
        default: 'ðŸš€ Files Updated'

      action_required_message:
        description: 'Custom action message'
        required: false
        type: string
        default: 'âš ï¸ Please review changes'

      card_color:
        description: 'Accent color theme (Accent, Good, Warning, Attention)'
        required: false
        type: string
        default: 'Accent'

      files:
        description: 'List of changed files'
        required: false
        type: string

    secrets:
      teams_webhook_url:
        required: true

jobs:
  notify-teams:
    runs-on: ubuntu-latest
    steps:
      - name: Send Teams Notification
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.teams_webhook_url }}
          NOTIFICATION_TITLE: ${{ inputs.notification_title }}
          ACTION_MESSAGE: ${{ inputs.action_required_message }}
          CARD_COLOR: ${{ inputs.card_color }}
          FILES: ${{ inputs.files }}
        run: |
          set -e

          if [ -z "$TEAMS_WEBHOOK_URL" ]; then
            echo "âŒ Missing teams_webhook_url secret."
            exit 1
          fi

          # Assign GitHub context safely to shell variables
          REPO="${GITHUB_REPOSITORY}"
          SHA="${GITHUB_SHA}"
          SHORT_SHA="${SHA:0:7}"
          TIMESTAMP=$(TZ='Europe/Belgrade' date +"%Y-%m-%d %H:%M %Z")
cat > payload.json <<EOF
{
  "type": "message",
  "attachments": [
    {
      "contentType": "application/vnd.microsoft.card.adaptive",
      "content": {
        "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
        "type": "AdaptiveCard",
        "version": "1.4",
        "body": [
          {
            "type": "TextBlock",
            "text": "$NOTIFICATION_TITLE",
            "weight": "Bolder",
            "color": "$CARD_COLOR"
          },
          {
            "type": "TextBlock",
            "text": "$ACTION_MESSAGE",
            "wrap": true
          },
          {
            "type": "TextBlock",
            "text": "ðŸ”— Commit: https://github.com/$REPO/commit/$SHA"
          },
          {
            "type": "TextBlock",
            "text": "ðŸ•’ Timestamp: $TIMESTAMP"
          },
          {
            "type": "TextBlock",
            "text": "ðŸ“‚ Files Changed:",
            "weight": "Bolder"
          },
          {
            "type": "TextBlock",
            "text": "$FILES",
            "fontType": "Monospace",
            "wrap": true
          }
        ]
      }
    }
  ]
}
EOF

          echo "ðŸ“¤ Sending notification to Teams..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$TEAMS_WEBHOOK_URL")

          if [ "$http_code" = "200" ] || [ "$http_code" = "202" ]; then
            echo "âœ… Teams notification sent!"
          else
            echo "âŒ Teams webhook failed with status $http_code"
            cat payload.json
            exit 1
          fi
